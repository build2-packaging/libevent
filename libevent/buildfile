intf_libs = # Interface dependencies.
impl_libs = # Implementation dependencies.
#import xxxx_libs += libhello%lib{hello}

using autoconf

# Extract values from the upstream CMakeLists.txt. Parse the file only once,
# # saving the lines of interest in memory, then extract the value from each
# # line.
# #

event_version_vars = \
  EVENT_GIT___VERSION_MAJOR \
  EVENT_GIT___VERSION_MINOR \
  EVENT_GIT___VERSION_PATCH
  #EVENT_GIT___VERSION_STAGE

re_version_vars = '.+set\((PLACEHOLDER)\s+([0-9]+)\)'
results =
for var : $event_version_vars
{
  re_var = $regex.replace($re_version_vars, "PLACEHOLDER", $var)
  lines = $process.run_regex(cat $src_base/VersionViaGit.cmake, "$re_var")
  val = $regex.merge($lines, $re_var, '\2', '', format_first_only format_no_copy)
  results += "$var = $val"
  # bring it in to scope (will expand to actual variable name)
  $var = $val
}

EVENT_GIT___VERSION_STAGE = "stable"
EVENT_STAGE_NAME = $EVENT_GIT___VERSION_STAGE

re_config_vars = '^set\((PLACEHOLDER)\s+(.+)\)'
event_config_vars = \
  EVENT_NUMERIC_VERSION \
  EVENT_ABI_LIBVERSION_CURRENT \
  EVENT_ABI_LIBVERSION_REVISION \
  EVENT_ABI_LIBVERSION_AGE \
  EVENT_PACKAGE_RELEASE

for var : $event_config_vars
{
  re_var = $regex.replace($re_config_vars, "PLACEHOLDER", $var)
  lines = $process.run_regex(cat $src_base/CMakeLists.txt, "$re_var")
  val = $regex.merge($lines, $re_var, '\2', '', format_first_only format_no_copy)
  results += "$var = $val"
  # bring it in to scope (will expand to actual variable name)
  $var = $val
}

# https://github.com/libevent/libevent/blob/5df3037d10556bfcb675bc73e516978b75fc7bc7/CMakeLists.txt#L68-L94
EVENT_VERSION_MAJOR = $EVENT_GIT___VERSION_MAJOR
EVENT_VERSION_MINOR = $EVENT_GIT___VERSION_MINOR
EVENT_VERSION_PATCH = $EVENT_GIT___VERSION_PATCH
EVENT_VERSION_STAGE = $EVENT_GIT___VERSION_STAGE
EVENT_VERSION = $EVENT_VERSION_MAJOR.$EVENT_VERSION_MINOR.$EVENT_VERSION_PATCH-$EVENT_STAGE_NAME

EVENT_ABI_MAJOR = $EVENT_VERSION_MAJOR
EVENT_ABI_MINOR = $EVENT_VERSION_MINOR
EVENT_ABI_PATCH = $EVENT_VERSION_PATCH

EVENT_ABI_LIBVERSION = "$EVENT_ABI_MAJOR.$EVENT_ABI_MINOR.$EVENT_ABI_PATCH"
EVENT_PACKAGE_VERSION = "$EVENT_VERSION_MAJOR.$EVENT_VERSION_MINOR.$EVENT_VERSION_PATCH"

# h{event2/event-config}: in{event2/event-config.h.cmake}
# {
#   autoconf.prefix="EVENT__"
#   EVENT__DISABLE_DEBUG_MODE = 1
#   EVENT__ENABLE_VERBOSE_DEBUG = 0
#   EVENT__DISABLE_MM_REPLACEMENT = 1
#   EVENT__DISABLE_THREAD_SUPPORT = 1
#   EVENT__DISABLE_OPENSSL = 1
#   EVENT__DISABLE_BENCHMARK = 1
#   EVENT__DISABLE_TESTS = 1
#   EVENT__DISABLE_REGRESS = 1
#   EVENT__DISABLE_SAMPLES = 1
#   EVENT__COVERAGE = 0
# }

# h{evconfig-private.h}: in{evconfig-private.h.cmake}

# event_core
lib{event_core}: {h c}{event2/event-config.h include/** src_core/*}
lib{event_core}: c{src_core/win/*}: include = ($c.target.class == 'windows')

#event extra
lib{event_extra}: {h c}{include/** src_extra/*} lib{event_core}

# event_openssl
# ...
# event_threads
# ...

./: lib{event}: {h c}{* include/**} $impl_libs $intf_libs lib{event_extra} lib{event_core}

#h{version}: in{version} $src_root/manifest
h{export}@./: c.importable = false

# Build options.
#
obj{src_core/*}: c.poptions += -Devent_core_shared_EXPORTS
obj{src_extra/*}: c.poptions += -Devent_extra_shared_EXPORTS

c.poptions =+ "-I$src_base" "-I$src_base/include" "-I$src_base/include_internal"

switch $c.target.class
{
  case 'windows'
  {
    c.libs += iphlpapi.lib ws2_32.lib shell32.lib advapi32.lib
  }
}

# Export options.
#
lib{event}:
{
  c.export.poptions = "-I$out_root" "-I$src_root"
  c.export.libs = $intf_libs
}

# For pre-releases use the complete version to make sure they cannot be used
# in place of another pre-release or the final version. See the version module
# for details on the version.* variable values.
#
if $version.pre_release
  lib{event}: bin.lib.version = "-$version.project_id"
else
  lib{event}: bin.lib.version = "-$version.major.$version.minor"

# Install into the libevent/ subdirectory of, say, /usr/include/
# recreating subdirectories.
#
{h}{*}:
{
  install         = include/libevent/
  install.subdirs = true
}
